<!DOCTYPE html>
<html>
<head>
    <title>Test UI Bubble Display</title>
    <style>
        .msg { margin: 10px 0; }
        .bubble { 
            padding: 10px; 
            border-radius: 10px; 
            background: #e0e0e0; 
            margin: 5px 0;
        }
        .bubble.assistant { background: #e3f2fd; }
        .bubble.user { background: #f3e5f5; text-align: right; }
        .content { white-space: pre-wrap; }
        .meta { font-size: 12px; color: #666; margin-bottom: 5px; }
        .pill { 
            background: #666; 
            color: white; 
            padding: 2px 6px; 
            border-radius: 3px; 
            font-size: 10px;
        }
        #status { 
            padding: 10px; 
            background: #fffde7; 
            border: 1px solid #f0f4c3;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <h1>Cedar Chat UI Test</h1>
    <div id="status">Connecting...</div>
    <div id="msgs"></div>
    
    <form id="testForm" style="margin-top: 20px;">
        <input type="text" id="input" value="what is 2+2" style="width: 300px;">
        <button type="submit">Send</button>
    </form>
    
    <script>
        const msgs = document.getElementById('msgs');
        const status = document.getElementById('status');
        
        function addMessage(type, role, text) {
            const wrap = document.createElement('div');
            wrap.className = 'msg ' + (role === 'user' ? 'user' : 'assistant');
            
            const meta = document.createElement('div');
            meta.className = 'meta';
            meta.innerHTML = '<span class="pill">' + role + '</span> <b>' + role.toUpperCase() + '</b>';
            
            const bubble = document.createElement('div');
            bubble.className = 'bubble ' + (role === 'user' ? 'user' : 'assistant');
            
            const content = document.createElement('div');
            content.className = 'content';
            content.textContent = text;
            
            bubble.appendChild(content);
            wrap.appendChild(meta);
            wrap.appendChild(bubble);
            msgs.appendChild(wrap);
            
            console.log('Added bubble:', type, role, text.substring(0, 50));
        }
        
        document.getElementById('testForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const input = document.getElementById('input').value;
            
            // Add user message
            addMessage('user', 'user', input);
            
            // Connect to WebSocket
            status.textContent = 'Connecting to WebSocket...';
            const ws = new WebSocket('ws://localhost:8000/ws/chat/44');
            
            ws.onopen = function() {
                status.textContent = 'Connected! Sending message...';
                ws.send(JSON.stringify({
                    type: 'message',
                    content: input
                }));
            };
            
            ws.onmessage = function(event) {
                try {
                    const m = JSON.parse(event.data);
                    console.log('Received:', m.type, m);
                    
                    if (m.type === 'message') {
                        // This is the final message!
                        status.textContent = '✅ Final message received!';
                        const role = m.role || 'assistant';
                        addMessage('message', role, m.text || '');
                        
                        // Close connection after final message
                        setTimeout(() => ws.close(), 1000);
                    } else if (m.type === 'agent_result') {
                        status.textContent = 'Agent: ' + (m.agent_name || 'processing...');
                    } else if (m.type === 'stream') {
                        status.textContent = 'Streaming: ' + (m.text || '...');
                    } else if (m.type === 'action') {
                        status.textContent = 'Action: ' + (m.function || 'processing');
                    }
                } catch(e) {
                    console.error('Parse error:', e);
                }
            };
            
            ws.onerror = function(e) {
                status.textContent = '❌ WebSocket error';
                console.error('WebSocket error:', e);
            };
            
            ws.onclose = function() {
                status.textContent += ' (Connection closed)';
            };
        });
        
        // Auto-submit on load for quick test
        window.addEventListener('load', function() {
            setTimeout(() => {
                document.getElementById('testForm').dispatchEvent(new Event('submit'));
            }, 500);
        });
    </script>
</body>
</html>
