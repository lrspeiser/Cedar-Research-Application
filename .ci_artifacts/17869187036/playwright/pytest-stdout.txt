
---------------------------- live log sessionstart -----------------------------
INFO     httpx:_client.py:1025 HTTP Request: GET https://api.openai.com/v1/models/gpt-5 "HTTP/1.1 200 OK"
============================= test session starts ==============================
platform linux -- Python 3.11.13, pytest-8.4.2, pluggy-1.6.0 -- /opt/hostedtoolcache/Python/3.11.13/x64/bin/python
cachedir: .pytest_cache
rootdir: /home/runner/work/cedarpy/cedarpy
configfile: pyproject.toml
plugins: playwright-0.7.1, base-url-2.1.0, anyio-4.10.0, cov-7.0.0
collecting ... collected 4 items

tests/test_playwright_chat_ack.py::test_chat_processing_ack_and_final[chromium-/] 
-------------------------------- live log call ---------------------------------
INFO     httpx:_client.py:1025 HTTP Request: GET https://api.openai.com/v1/models/gpt-5 "HTTP/1.1 200 OK"
INFO     httpx:_client.py:1025 HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
INFO     httpx:_client.py:1025 HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
INFO     httpx:_client.py:1025 HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
INFO     httpx:_client.py:1025 HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
INFO     httpx:_client.py:1025 HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
INFO     httpx:_client.py:1025 HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
INFO     httpx:_client.py:1025 HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
INFO     httpx:_client.py:1025 HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
FAILED                                                                   [ 25%]

=================================== FAILURES ===================================
________________ test_chat_processing_ack_and_final[chromium-/] ________________

page = <Page url='http://127.0.0.1:35961/project/1?branch_id=1'>, path = '/'

    @pytest.mark.parametrize("path", ["/"])
    def test_chat_processing_ack_and_final(page: Page, path: str):
        port = _find_free_port()
        server, thread = _start_server(port)
        try:
            base = f"http://127.0.0.1:{port}"
            page.goto(base + path)
            # Create project
            unique_title = f"Chat ACK {int(time.time()*1000000)}"
            page.fill("input[name=title]", unique_title)
            page.locator("form[action='/projects/create'] button[type=submit]").click()
            page.wait_for_url("**/project/*")
    
            # Submit a simple chat message
            page.fill("#chatInput", "what is 2+2")
            page.locator("#chatForm button[type=submit]").click()
    
            # 1) Visible processing acknowledgment appears quickly
            expect(page.locator("#msgs").get_by_text("Processing…")).to_be_visible(timeout=3000)
    
            # 2) Server-side stages should show (submitted/planning/finalizing/persisted) or explicit timeout.
            # Allow generous time for LLM and align with server timeout (90s)
            page.wait_for_function(
                "() => { const el = document.querySelector('#msgs'); if (!el) return false; const t = el.innerText || ''; return t.includes('finalizing') || t.includes('persisted') || t.includes('timeout'); }",
                timeout=95000,
            )
    
            # 3) The processing text is eventually replaced (no longer present)
            # It may be replaced by the final text or a timeout message
            page.wait_for_function(
                "() => { const el = document.querySelector('#msgs'); if (!el) return false; return !el.innerText.includes('Processing…'); }",
                timeout=95000,
            )
    
            # 4) Optionally, when LLM keys are provided, the final bubble should include "4" for this trivial query
            if os.getenv("OPENAI_API_KEY") or os.getenv("CEDARPY_OPENAI_API_KEY"):
                # Look for assistant bubble content containing "4"
                # Be lenient: any visible '4' within the msgs area after completion
>               assert page.locator("#msgs").get_by_text("4").count() >= 1
E               assert 0 >= 1
E                +  where 0 = count()
E                +    where count = <Locator frame=<Frame name= url='http://127.0.0.1:35961/project/1?branch_id=1'> selector='#msgs >> internal:text="4"i'>.count
E                +      where <Locator frame=<Frame name= url='http://127.0.0.1:35961/project/1?branch_id=1'> selector='#msgs >> internal:text="4"i'> = get_by_text('4')
E                +        where get_by_text = <Locator frame=<Frame name= url='http://127.0.0.1:35961/project/1?branch_id=1'> selector='#msgs'>.get_by_text
E                +          where <Locator frame=<Frame name= url='http://127.0.0.1:35961/project/1?branch_id=1'> selector='#msgs'> = locator('#msgs')
E                +            where locator = <Page url='http://127.0.0.1:35961/project/1?branch_id=1'>.locator

tests/test_playwright_chat_ack.py:101: AssertionError
----------------------------- Captured stdout call -----------------------------
[cedarpy] Created and mounted /uploads-legacy at /home/runner/CedarPyData/user_uploads
[cedarpy] Mounted /uploads-legacy from /home/runner/CedarPyData/user_uploads
[llm-ready] model=gpt-5 key=ok
[startup] LLM ready (model=gpt-5)
INFO:     127.0.0.1:46338 - "GET / HTTP/1.1" 200 OK
INFO:     127.0.0.1:46348 - "GET / HTTP/1.1" 200 OK
[client-log] ts=2025-09-19T20:35:51.350Z level=INFO host=127.0.0.1 origin=console.log url=http://127.0.0.1:35961/ loc= ua=Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) HeadlessChrome/140.0.7339.16 Safari/537.36 msg=[ui] page ready
INFO:     127.0.0.1:46348 - "POST /api/client-log HTTP/1.1" 200 OK
INFO:     127.0.0.1:46348 - "POST /projects/create HTTP/1.1" 303 See Other
INFO:     127.0.0.1:46348 - "GET /project/1?branch_id=1 HTTP/1.1" 200 OK
[client-log] ts=2025-09-19T20:35:51.552Z level=INFO host=127.0.0.1 origin=console.log url=http://127.0.0.1:35961/project/1?branch_id=1 loc= ua=Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) HeadlessChrome/140.0.7339.16 Safari/537.36 msg=[ui] page ready
INFO:     127.0.0.1:46348 - "POST /api/client-log HTTP/1.1" 200 OK
INFO:     127.0.0.1:46348 - "GET /project/1/threads/new?branch_id=1&json=1 HTTP/1.1" 200 OK
[ws-chat] accepted project_id=1
[ws-chat] submitted
[ws-chat] planning-sent
[ws-chat] llm-call
[ws-chat] llm-call
[ws-chat] llm-call
[ws-chat] llm-call
[ws-chat] llm-call
[ws-chat] llm-call
[ws-chat] llm-call
[ws-chat] llm-call
----------------------------- Captured stderr call -----------------------------
INFO:     Started server process [3576]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
INFO:     Uvicorn running on http://127.0.0.1:35961 (Press CTRL+C to quit)
INFO:     127.0.0.1:46354 - "WebSocket /ws/chat/1" [accepted]
INFO:     connection open
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: GET https://api.openai.com/v1/models/gpt-5 "HTTP/1.1 200 OK"
INFO     httpx:_client.py:1025 HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
INFO     httpx:_client.py:1025 HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
INFO     httpx:_client.py:1025 HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
INFO     httpx:_client.py:1025 HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
INFO     httpx:_client.py:1025 HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
INFO     httpx:_client.py:1025 HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
INFO     httpx:_client.py:1025 HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
INFO     httpx:_client.py:1025 HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
=============================== warnings summary ===============================
tests/test_playwright_chat_ack.py::test_chat_processing_ack_and_final[chromium-/]
tests/test_playwright_chat_ack.py::test_chat_processing_ack_and_final[chromium-/]
  /home/runner/work/cedarpy/cedarpy/main.py:1198: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    @app.on_event("startup")

tests/test_playwright_chat_ack.py::test_chat_processing_ack_and_final[chromium-/]
tests/test_playwright_chat_ack.py::test_chat_processing_ack_and_final[chromium-/]
  /opt/hostedtoolcache/Python/3.11.13/x64/lib/python3.11/site-packages/fastapi/applications.py:4495: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    return self.router.on_event(event_type)

tests/test_playwright_chat_ack.py::test_chat_processing_ack_and_final[chromium-/]
  /opt/hostedtoolcache/Python/3.11.13/x64/lib/python3.11/site-packages/websockets/legacy/__init__.py:6: DeprecationWarning: websockets.legacy is deprecated; see https://websockets.readthedocs.io/en/stable/howto/upgrade.html for upgrade instructions
    warnings.warn(  # deprecated in 14.0 - 2024-11-09

tests/test_playwright_chat_ack.py::test_chat_processing_ack_and_final[chromium-/]
  /opt/hostedtoolcache/Python/3.11.13/x64/lib/python3.11/site-packages/uvicorn/protocols/websockets/websockets_impl.py:17: DeprecationWarning: websockets.server.WebSocketServerProtocol is deprecated
    from websockets.server import WebSocketServerProtocol

tests/test_playwright_chat_ack.py::test_chat_processing_ack_and_final[chromium-/]
  /opt/hostedtoolcache/Python/3.11.13/x64/lib/python3.11/site-packages/websockets/legacy/server.py:1178: DeprecationWarning: remove second argument of ws_handler
    warnings.warn("remove second argument of ws_handler", DeprecationWarning)

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
--- generated xml file: /home/runner/work/cedarpy/cedarpy/reports/junit.xml ----
============================= slowest 25 durations =============================
96.66s call     tests/test_playwright_chat_ack.py::test_chat_processing_ack_and_final[chromium-/]
2.22s setup    tests/test_playwright_chat_ack.py::test_chat_processing_ack_and_final[chromium-/]
0.05s teardown tests/test_playwright_chat_ack.py::test_chat_processing_ack_and_final[chromium-/]
=========================== short test summary info ============================
FAILED tests/test_playwright_chat_ack.py::test_chat_processing_ack_and_final[chromium-/] - assert 0 >= 1
 +  where 0 = count()
 +    where count = <Locator frame=<Frame name= url='http://127.0.0.1:35961/project/1?branch_id=1'> selector='#msgs >> internal:text="4"i'>.count
 +      where <Locator frame=<Frame name= url='http://127.0.0.1:35961/project/1?branch_id=1'> selector='#msgs >> internal:text="4"i'> = get_by_text('4')
 +        where get_by_text = <Locator frame=<Frame name= url='http://127.0.0.1:35961/project/1?branch_id=1'> selector='#msgs'>.get_by_text
 +          where <Locator frame=<Frame name= url='http://127.0.0.1:35961/project/1?branch_id=1'> selector='#msgs'> = locator('#msgs')
 +            where locator = <Page url='http://127.0.0.1:35961/project/1?branch_id=1'>.locator
!!!!!!!!!!!!!!!!!!!!!!!!!! stopping after 1 failures !!!!!!!!!!!!!!!!!!!!!!!!!!!
=================== 1 failed, 7 warnings in 99.20s (0:01:39) ===================
